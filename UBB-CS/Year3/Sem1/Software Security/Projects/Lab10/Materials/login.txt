<?php

	session_start();

	

	$mysqli = new mysqli("localhost", "root", "", "test");

	

	// Check connection

	if ($mysqli->connect_errno)

	{

		die("Failed to connect to MySQL: " . mysqli_connect_error());

	}

	

	function do_query($mysqli, $query)

	{

		if (!($result = $mysqli->query($query)))

		{

			die("ERROR: ". $mysqli->error . " in: [$query]");

		}

		

		return $result;

	}



	function show_form()

	{

?>

<form action=login.php method=post>

<center><br><br><br><table>

<tr><th>Username<td><input type=text name=user>

<tr><th>Password<td><input type=password name=pass>

<tr><td colspan=3 align=center><input type=submit name=submit value=Login>

</form>

<?php

	}



	if (isset($_POST['user']))

	{

		$query = "SELECT * from users WHERE user='".$_POST['user']."' AND pass='".$_POST['pass']."'";

		//$query = mysqli_real_escape_string($mysqli, $query);

		$result = do_query($mysqli, $query);

		if (mysqli_num_rows($result) == 1)

		{

			$row = mysqli_fetch_array($result);

			

			$_SESSION['id'] = $row['id'];

			$_SESSION['login_query'] = $query;

			$_SESSION['user'] = $row['user'];

			

			header("location:login.php");	

		}

		else

		{

			show_form();

			echo "<br>Login failed.";

		}

	}

	else if (isset($_SESSION['id']))

	{

		if (isset($_GET['action']) && ($_GET['action'] == 'logout'))

		{

			session_destroy();

			header("location:login.php");

		}

	

		echo "Logged in with user <b>".$_SESSION['user']."</b><br><li><a href=login.php?action=logout>Logout</a><br><br>\n";

			

		echo "Login query:<pre>".$_SESSION['login_query']. "<br><br></pre>";

		

		if (isset($_POST['id']))

		{

			$id = $_POST['id'];

		}

		else

			$id = '';

			

		echo "Get information for user with id: <form name=getinfo method=post action=login.php><input type=text name=id size=100 value='$id'><br><input type=submit name=submit value='Get information'></form>";

			

		if (isset($_POST['id']))

		{

			$query = "SELECT * from users WHERE id=" . $_POST['id'];

			echo "Get info query: <pre>".$query. "<br></pre>";

			echo "<br><table border=1 cellspacing=0 cellpadding=5>";

			$result = do_query($mysqli, $query);

			while ($row = mysqli_fetch_array($result))

			{

				echo "<tr><td><pre>".$row['user']."<td><pre>".$row['name']."<td><pre>".$row['email'];

			}

			echo "</table>";

		}

		

		echo "\n<br><hr><br>";

		

		if (isset($_POST['submitmsg']))

		{

			$mesaj = $_POST['msg'];

			echo $mesaj."<br>";

			$query = "INSERT INTO messages VALUES (0, " . $_POST['userid']. ", \"" . $mesaj. "\")";

			echo "INSERT query: <pre>".$query. "<br></pre>";

			if (!($result = $mysqli->query($query)))

			{

				echo "mysql error: " . $mysqli->error;

			}

		}

		if (isset($_GET['action']) && ($_GET['action'] == 'delete'))

		{

			$mysqli->query("DELETE FROM messages WHERE id_user=" . $_SESSION['id']);

		}

		

		echo "Add a message:<form name=addmsg method=post action=login.php><textarea name=msg></textarea><br><input type=hidden name=userid value='".$_SESSION['id']."'><input type=submit name=submitmsg value=Trimite></form><br>";

		echo "Lista de mesaje\n";

		echo "<table border=1 cellspacing=0 cellpadding=4><tr><th>Id<th>User<th>Mesaj</th>\n";

		$query = "SELECT M.id AS id, M.message AS msg, U.name AS name FROM messages M, users U WHERE M.id_user=U.id";

		$result = do_query($mysqli, $query);

		while ($row = mysqli_fetch_array($result))

		{

			echo "<tr><td>" . $row['id'] . "<td>" . $row['name'] . "<td>" . $row['msg'] . "\n";

		}

		echo "</table>\n";

		

		echo "Delete own messages: <a href=login.php?action=delete>click</a>\n";

	}

	else

	{

		show_form();

	}

?>
